<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>
        Document
    </title>
    <link rel='stylesheet' href=../../../css/index.css />
    <link rel='stylesheet' href=../../../css/c.css /><link rel='stylesheet' href=../../../css/makefile.css /><link rel='stylesheet' href=../../../css/shell.css /><link rel='stylesheet' href=../../../css/txt.css /><link rel='stylesheet' href=../../../css/xml.css />
    <link rel="icon" href="https://raw.githubusercontent.com/learner-lu/picbed/master/logo.png">
</head>

<body class="light">
    <a href="https://github.com/luzhixing12345/qemu-kvm.git" target="_blank" class="github-corner" aria-label="View source on GitHub"><svg width="80" height="80" viewBox="0 0 250 250" style="fill:#151513; color:#fff; position: absolute; top: 0; border: 0; right: 0;" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a><style>.github-corner:hover .octo-arm{animation:octocat-wave 560ms ease-in-out}@keyframes octocat-wave{0%,100%{transform:rotate(0)}20%,60%{transform:rotate(-25deg)}40%,80%{transform:rotate(10deg)}}@media (max-width:500px){.github-corner:hover .octo-arm{animation:none}.github-corner .octo-arm{animation:octocat-wave 560ms ease-in-out}}</style>
    <div class="header-navigator"><ul><li><a href="#h1-0">pml</a><ul><li><a href="#h2-1">使用 PML</a></li></ul><ul><li><a href="#h2-2">性能分析</a><ul><li><a href="#h3-3">读写</a></li></ul><ul><li><a href="#h3-4">迁移速度</a></li></ul></li></ul><ul><li><a href="#h2-5">问题</a></li></ul><ul><li><a href="#h2-6">结论</a></li></ul><ul><li><a href="#h2-7">改进: PRL</a></li></ul><ul><li><a href="#h2-8">参考</a></li></ul></li></ul></div><div class='markdown-body'><h1 id="h1-0">pml</h1><p>PML是一项英特尔虚拟化技术功能,可扩展虚拟机管理程序的功能,使其能够有效跟踪或监控虚拟机在执行期间修改的来宾物理内存页面.PML依赖于扩展页表(EPT)硬件支持来实现MMU虚拟化,并且需要对虚拟机控制结构(VMCS)进行特定更改.引入了称为PML地址的新64位VM执行控制字段</p><p>PML 地址指向称为 PML 日志记录缓冲区的 4KB 对齐物理内存页.该缓冲区被组织成 512 个 64 位条目,用于存储记录的 GPA.还引入了称为 PML 索引的新 16 位客户状态字段.</p><p>当 PML 启用时,<b>在页遍历期间在 EPT 中设置脏标志的每个写指令都会触发相应 GPA 的记录</b>(与脏标志条目有关).然后,PML 索引减 1.只要 <b>PML 日志记录缓冲区已满,处理器就会触发 VMExit,虚拟机管理程序开始发挥作用</b>.</p><p>PML 索引是日志记录缓冲区中下一个条目的逻辑索引.由于缓冲区包含 512 个条目,因此 PML 索引的值范围为 0 到 511, 起始索引为 511, 每增加一条记录索引减 1, 最终的索引为 0. 当索引为 0 时触发 VMEXIT, 当索引重置为 511 后,日志记录过程将重新启动.</p><p><a data-lightbox="example-1" href="https://raw.githubusercontent.com/learner-lu/picbed/master/20241030152657.png"><img loading="lazy" src="https://raw.githubusercontent.com/learner-lu/picbed/master/20241030152657.png" alt="20241030152657"></a></p><p>上图展示了 PML 用于改进虚拟化操作(例如实时迁移)时的一般工作流程.该图的一侧显示了作为虚拟化操作目标的用户 VM(绿色),另一侧显示了 dom0,它运行实现此虚拟化操作的系统</p><blockquote style="border-left-color: #0969da; background-color: #e8f3ff;"><p><div style="color: #0969da;"><img class="icon-note" loading="lazy" src="../../../img/note.svg" alt="[!NOTE]"> NOTE </div> dom0 是 Xen hypervisor 中使用的术语. dom0 是指&quot;域 0&quot;(Domain 0),它是一个特权域,负责管理其他虚拟机(通常称为 domU,即非特权域).dom0 拥有直接访问硬件资源的权限,并且可以执行设备驱动程序,处理 I/O 请求,以及管理虚拟机的生命周期.类似 host OS</p></blockquote><p>完整流程分为如下几步, 从 PML activation 开始</p><ol start="1"><li>虚拟机的 CPU 可以开始记录 GPA</li></ol><ol start="2"><li>当 PML 日志记录缓冲区已满时,CPU 会触发陷入虚拟机管理程序的 VMExit.</li></ol><ol start="3"><li>该 VMExit 的处理程序执行特定任务(例如,将 PML 日志记录缓冲区的内容复制到与 dom0 共享的更大缓冲区).</li></ol><ol start="4"><li>PML 索引重置为 511,VM 恢复 (VMEnter).实现虚拟化操作的系统(在 dom0 中)定期对日志满处理程序生成的结果进行操作</li></ol><blockquote><p>虚拟机也可以选择在某些情况下禁用 PML</p></blockquote><h2 id="h2-1">使用 PML</h2><p>pml 在 Linux 的 KVM 模块中已经支持了, 只需要编译时启用 CONFIG_KVM 即可, pml 会默认启用(enable_pml=1), 如果没有启用 EPT 或者 CPU 不支持 pml 则会自动禁用, 相关代码如下</p><pre class="language-c"><code><span class="Token COMMENT">// /arch/x86/kvm/vmx/vmx.c</span><span class="Token LF">
</span><span class="Token Keyword BaseType TypeSpecifier BOOL">bool</span><span class="Token Keyword BaseType TypeSpecifier SPACE"> </span><span class="Token MacroDefine Keyword Typedefine TypeSpecifier TYPEDEF_ID">__read_mostly</span><span class="Token Keyword Typedefine TypeSpecifier SPACE"> </span><span class="Token Identifier DirectDeclaractor ID">enable_pml</span><span class="Token Identifier DirectDeclaractor SPACE"> </span><span class="Token InitDeclarator ASSIGN">=</span><span class="Token InitDeclarator SPACE"> </span><span class="Token Constant PrimaryExpression NUMBER">1</span><span class="Token Declaration SEMI">;</span><span class="Token Declaration LF">
</span><span class="Token Declaration LF">
</span><span class="Token Keyword StorageType FunctionReturnType STATIC">static</span><span class="Token Keyword StorageType FunctionReturnType SPACE"> </span><span class="Token MacroDefine Keyword Typedefine TypeSpecifier FunctionReturnType TYPEDEF_ID">__init</span><span class="Token Keyword Typedefine TypeSpecifier FunctionReturnType SPACE"> </span><span class="Token Keyword BaseType TypeSpecifier FunctionReturnType INT">int</span><span class="Token Keyword BaseType TypeSpecifier FunctionReturnType SPACE"> </span><span class="Token Identifier DirectDeclaractor FunctionName FunctionName ID">hardware_setup</span><span class="Token DirectDeclaractor Declarator BraceDepth-0 LPAREN">(</span><span class="Token Keyword BaseType TypeSpecifier VOID">void</span><span class="Token DirectDeclaractor Declarator BraceDepth-0 RPAREN">)</span><span class="Token DirectDeclaractor Declarator SPACE"> </span><span class="Token CompoundStatement Function BraceDepth-0 LCURLY_BRACE">{</span><span class="Token CompoundStatement Function LF">
</span><span class="Token CompoundStatement Function SPACE">    </span><span class="Token CompoundStatement Function COMMENT">/*
     * Only enable PML when hardware supports PML feature, and both EPT
     * and EPT A/D bit features are enabled -- PML depends on them to work.
     */</span><span class="Token CompoundStatement Function LF">
</span><span class="Token CompoundStatement Function SPACE">    </span><span class="Token Keyword SelectionStatement IF">if</span><span class="Token Keyword SelectionStatement SPACE"> </span><span class="Token SelectionStatement BraceDepth-1 LPAREN">(</span><span class="Token UnaryOp UnaryExpression BANG">!</span><span class="Token Identifier PrimaryExpression ID">enable_ept</span><span class="Token Identifier PrimaryExpression SPACE"> </span><span class="Token BinaryOp ConditionalExpression OR">||</span><span class="Token BinaryOp ConditionalExpression SPACE"> </span><span class="Token UnaryOp UnaryExpression BANG">!</span><span class="Token Identifier PrimaryExpression ID">enable_ept_ad_bits</span><span class="Token Identifier PrimaryExpression SPACE"> </span><span class="Token BinaryOp ConditionalExpression OR">||</span><span class="Token BinaryOp ConditionalExpression SPACE"> </span><span class="Token UnaryOp UnaryExpression BANG">!</span><span class="Token Identifier PrimaryExpression FunctionCall ID">cpu_has_vmx_pml</span><span class="Token PostfixExpression UnaryExpression BraceDepth-2 LPAREN">(</span><span class="Token PostfixExpression UnaryExpression BraceDepth-2 RPAREN">)</span><span class="Token SelectionStatement BraceDepth-1 RPAREN">)</span><span class="Token SelectionStatement LF">
</span><span class="Token SelectionStatement SPACE">        </span><span class="Token Identifier PrimaryExpression ID">enable_pml</span><span class="Token Identifier PrimaryExpression SPACE"> </span><span class="Token AssignOp AssignmentExpression ASSIGN">=</span><span class="Token AssignOp AssignmentExpression SPACE"> </span><span class="Token Constant PrimaryExpression NUMBER">0</span><span class="Token ExpressionStatement SelectionStatement SEMI">;</span><span class="Token ExpressionStatement SelectionStatement LF">
</span><span class="Token ExpressionStatement SelectionStatement SPACE">    </span><span class="Token ExpressionStatement SelectionStatement COMMENT">// ...</span><span class="Token ExpressionStatement SelectionStatement LF">
</span><span class="Token CompoundStatement Function BraceDepth-0 RCURLY_BRACE">}</span><span class="Token CompoundStatement Function LF">
</span><span class="Token CompoundStatement Function LF">
</span><span class="Token Keyword StorageType FunctionReturnType STATIC">static</span><span class="Token Keyword StorageType FunctionReturnType SPACE"> </span><span class="Token Keyword FunctionType FunctionReturnType INLINE">inline</span><span class="Token Keyword FunctionType FunctionReturnType SPACE"> </span><span class="Token Keyword BaseType TypeSpecifier FunctionReturnType BOOL">bool</span><span class="Token Keyword BaseType TypeSpecifier FunctionReturnType SPACE"> </span><span class="Token Identifier DirectDeclaractor FunctionName FunctionName ID">cpu_has_vmx_pml</span><span class="Token DirectDeclaractor Declarator BraceDepth-0 LPAREN">(</span><span class="Token Keyword BaseType TypeSpecifier VOID">void</span><span class="Token DirectDeclaractor Declarator BraceDepth-0 RPAREN">)</span><span class="Token DirectDeclaractor Declarator LF">
</span><span class="Token CompoundStatement Function BraceDepth-0 LCURLY_BRACE">{</span><span class="Token CompoundStatement Function LF">
</span><span class="Token CompoundStatement Function SPACE">    </span><span class="Token Keyword JumpStatement RETURN">return</span><span class="Token Keyword JumpStatement SPACE"> </span><span class="Token Identifier PrimaryExpression ID">vmcs_config</span><span class="Token PostfixExpression UnaryExpression DOT">.</span><span class="Token Identifier ID">cpu_based_2nd_exec_ctrl</span><span class="Token Identifier SPACE"> </span><span class="Token BinaryOp ConditionalExpression AMPERSAND">&amp;</span><span class="Token BinaryOp ConditionalExpression SPACE"> </span><span class="Token Identifier MacroDefine PrimaryExpression ID">SECONDARY_EXEC_ENABLE_PML</span><span class="Token JumpStatement SEMI">;</span><span class="Token JumpStatement LF">
</span><span class="Token CompoundStatement Function BraceDepth-0 RCURLY_BRACE">}</span></code></pre><p>判断是否支持 PML 的宏 SECONDARY_EXEC_ENABLE_PML 对应 QEMU 中的 VMX_SECONDARY_EXEC_ENABLE_PML, 可以看到在所有 x86 的 CPU 作为 builtin 的 features 已被启用</p><p><a data-lightbox="example-1" href="https://raw.githubusercontent.com/learner-lu/picbed/master/20241030234000.png"><img loading="lazy" src="https://raw.githubusercontent.com/learner-lu/picbed/master/20241030234000.png" alt="20241030234000"></a></p><p>在真机上可以使用如下命令查看当前 CPU 是否支持 pml</p><pre class="language-shell"><code><span class="Token Program ID">cat</span><span class="Token SPACE"> </span><span class="Token PATH">/proc/cpuinfo</span><span class="Token SPACE"> </span><span class="Token PIPE">|</span><span class="Token SPACE"> </span><span class="Token Program ID">grep</span><span class="Token SPACE"> </span><span class="Token ID">pml</span></code></pre><p>pml 的全部代码修改均位于 <code>arch/x86/kvm/vmx/vmx.c</code>, 在 vcpu 初始化时, 为 vmx-&gt;pml_pg 分配空间</p><pre class="language-c"><code><span class="Token Keyword StorageType FunctionReturnType STATIC">static</span><span class="Token Keyword StorageType FunctionReturnType SPACE"> </span><span class="Token Keyword BaseType TypeSpecifier FunctionReturnType INT">int</span><span class="Token Keyword BaseType TypeSpecifier FunctionReturnType SPACE"> </span><span class="Token Identifier DirectDeclaractor FunctionName FunctionName ID">vmx_vcpu_create</span><span class="Token DirectDeclaractor Declarator BraceDepth-0 LPAREN">(</span><span class="Token Keyword StructureType Structure TypeSpecifier STRUCT">struct</span><span class="Token Keyword StructureType Structure TypeSpecifier SPACE"> </span><span class="Token Identifier Structure StructureClass TypeSpecifier ID">kvm_vcpu</span><span class="Token Identifier Structure StructureClass TypeSpecifier SPACE"> </span><span class="Token Pointer Declarator POINTER">*</span><span class="Token Identifier DirectDeclaractor ID">vcpu</span><span class="Token DirectDeclaractor Declarator BraceDepth-0 RPAREN">)</span><span class="Token DirectDeclaractor Declarator LF">
</span><span class="Token CompoundStatement Function BraceDepth-0 LCURLY_BRACE">{</span><span class="Token CompoundStatement Function LF">
</span><span class="Token CompoundStatement Function SPACE">    </span><span class="Token CompoundStatement Function COMMENT">// ...</span><span class="Token CompoundStatement Function LF">
</span><span class="Token CompoundStatement Function SPACE">    </span><span class="Token Keyword SelectionStatement IF">if</span><span class="Token Keyword SelectionStatement SPACE"> </span><span class="Token SelectionStatement BraceDepth-1 LPAREN">(</span><span class="Token Identifier PrimaryExpression ID">enable_pml</span><span class="Token SelectionStatement BraceDepth-1 RPAREN">)</span><span class="Token SelectionStatement SPACE"> </span><span class="Token CompoundStatement SelectionStatement BraceDepth-1 LCURLY_BRACE">{</span><span class="Token CompoundStatement SelectionStatement LF">
</span><span class="Token CompoundStatement SelectionStatement SPACE">        </span><span class="Token Identifier PrimaryExpression ID">vmx</span><span class="Token PostfixExpression UnaryExpression POINT">-&gt;</span><span class="Token Identifier ID">pml_pg</span><span class="Token Identifier SPACE"> </span><span class="Token AssignOp AssignmentExpression ASSIGN">=</span><span class="Token AssignOp AssignmentExpression SPACE"> </span><span class="Token Identifier PrimaryExpression FunctionCall ID">alloc_page</span><span class="Token PostfixExpression UnaryExpression BraceDepth-2 LPAREN">(</span><span class="Token Identifier MacroDefine PrimaryExpression ID">GFP_KERNEL_ACCOUNT</span><span class="Token Identifier MacroDefine PrimaryExpression SPACE"> </span><span class="Token BinaryOp ConditionalExpression PIPE">|</span><span class="Token BinaryOp ConditionalExpression SPACE"> </span><span class="Token Identifier MacroDefine PrimaryExpression ID">__GFP_ZERO</span><span class="Token PostfixExpression UnaryExpression BraceDepth-2 RPAREN">)</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">        </span><span class="Token Keyword SelectionStatement IF">if</span><span class="Token Keyword SelectionStatement SPACE"> </span><span class="Token SelectionStatement BraceDepth-2 LPAREN">(</span><span class="Token UnaryOp UnaryExpression BANG">!</span><span class="Token Identifier PrimaryExpression ID">vmx</span><span class="Token PostfixExpression UnaryExpression POINT">-&gt;</span><span class="Token Identifier ID">pml_pg</span><span class="Token SelectionStatement BraceDepth-2 RPAREN">)</span><span class="Token SelectionStatement LF">
</span><span class="Token SelectionStatement SPACE">            </span><span class="Token Keyword JumpStatement GOTO">goto</span><span class="Token Keyword JumpStatement SPACE"> </span><span class="Token Identifier JumpStatement GotoLabel ID">free_vpid</span><span class="Token JumpStatement SelectionStatement SEMI">;</span><span class="Token JumpStatement SelectionStatement LF">
</span><span class="Token JumpStatement SelectionStatement SPACE">    </span><span class="Token CompoundStatement SelectionStatement BraceDepth-1 RCURLY_BRACE">}</span><span class="Token CompoundStatement SelectionStatement LF">
</span><span class="Token CompoundStatement Function BraceDepth-0 RCURLY_BRACE">}</span></code></pre><p>写入时调用 nested_vmx_write_pml_buffer, 当 pml index 满后设置 pml_full 为 true</p><pre class="language-c"><code><span class="Token Keyword StorageType FunctionReturnType STATIC">static</span><span class="Token Keyword StorageType FunctionReturnType SPACE"> </span><span class="Token Keyword BaseType TypeSpecifier FunctionReturnType INT">int</span><span class="Token Keyword BaseType TypeSpecifier FunctionReturnType SPACE"> </span><span class="Token Identifier DirectDeclaractor FunctionName FunctionName ID">nested_vmx_write_pml_buffer</span><span class="Token DirectDeclaractor Declarator BraceDepth-0 LPAREN">(</span><span class="Token Keyword StructureType Structure TypeSpecifier STRUCT">struct</span><span class="Token Keyword StructureType Structure TypeSpecifier SPACE"> </span><span class="Token Identifier Structure StructureClass TypeSpecifier ID">kvm_vcpu</span><span class="Token Identifier Structure StructureClass TypeSpecifier SPACE"> </span><span class="Token Pointer Declarator POINTER">*</span><span class="Token Identifier DirectDeclaractor ID">vcpu</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token Keyword Typedefine TypeSpecifier TYPEDEF_ID">gpa_t</span><span class="Token Keyword Typedefine TypeSpecifier SPACE"> </span><span class="Token Identifier DirectDeclaractor ID">gpa</span><span class="Token DirectDeclaractor Declarator BraceDepth-0 RPAREN">)</span><span class="Token DirectDeclaractor Declarator LF">
</span><span class="Token CompoundStatement Function BraceDepth-0 LCURLY_BRACE">{</span><span class="Token CompoundStatement Function LF">
</span><span class="Token CompoundStatement Function SPACE">    </span><span class="Token Keyword StructureType Structure TypeSpecifier STRUCT">struct</span><span class="Token Keyword StructureType Structure TypeSpecifier SPACE"> </span><span class="Token Identifier Structure StructureClass TypeSpecifier ID">vmcs12</span><span class="Token Identifier Structure StructureClass TypeSpecifier SPACE"> </span><span class="Token Pointer Declarator POINTER">*</span><span class="Token Identifier DirectDeclaractor ID">vmcs12</span><span class="Token Declaration SEMI">;</span><span class="Token Declaration LF">
</span><span class="Token Declaration SPACE">    </span><span class="Token Keyword StructureType Structure TypeSpecifier STRUCT">struct</span><span class="Token Keyword StructureType Structure TypeSpecifier SPACE"> </span><span class="Token Identifier Structure StructureClass TypeSpecifier ID">vcpu_vmx</span><span class="Token Identifier Structure StructureClass TypeSpecifier SPACE"> </span><span class="Token Pointer Declarator POINTER">*</span><span class="Token Identifier DirectDeclaractor ID">vmx</span><span class="Token Identifier DirectDeclaractor SPACE"> </span><span class="Token InitDeclarator ASSIGN">=</span><span class="Token InitDeclarator SPACE"> </span><span class="Token Identifier PrimaryExpression FunctionCall ID">to_vmx</span><span class="Token PostfixExpression UnaryExpression BraceDepth-1 LPAREN">(</span><span class="Token Identifier PrimaryExpression ID">vcpu</span><span class="Token PostfixExpression UnaryExpression BraceDepth-1 RPAREN">)</span><span class="Token Declaration SEMI">;</span><span class="Token Declaration LF">
</span><span class="Token Declaration SPACE">    </span><span class="Token Keyword Typedefine TypeSpecifier TYPEDEF_ID">gpa_t</span><span class="Token Keyword Typedefine TypeSpecifier SPACE"> </span><span class="Token Identifier DirectDeclaractor ID">dst</span><span class="Token Declaration SEMI">;</span><span class="Token Declaration LF">
</span><span class="Token Declaration LF">
</span><span class="Token Declaration SPACE">    </span><span class="Token Keyword SelectionStatement IF">if</span><span class="Token Keyword SelectionStatement SPACE"> </span><span class="Token SelectionStatement BraceDepth-1 LPAREN">(</span><span class="Token Identifier MacroDefine PrimaryExpression ID">WARN_ON_ONCE</span><span class="Token BraceDepth-2 LPAREN">(</span><span class="Token PPtoken BANG">!</span><span class="Token Identifier ID">is_guest_mode</span><span class="Token PPtoken BraceDepth-0 LPAREN">(</span><span class="Token Identifier ID">vcpu</span><span class="Token PPtoken BraceDepth-0 RPAREN">)</span><span class="Token BraceDepth-2 RPAREN">)</span><span class="Token SelectionStatement BraceDepth-1 RPAREN">)</span><span class="Token SelectionStatement LF">
</span><span class="Token SelectionStatement SPACE">        </span><span class="Token Keyword JumpStatement RETURN">return</span><span class="Token Keyword JumpStatement SPACE"> </span><span class="Token Constant PrimaryExpression NUMBER">0</span><span class="Token JumpStatement SelectionStatement SEMI">;</span><span class="Token JumpStatement SelectionStatement LF">
</span><span class="Token JumpStatement SelectionStatement LF">
</span><span class="Token JumpStatement SelectionStatement SPACE">    </span><span class="Token Keyword SelectionStatement IF">if</span><span class="Token Keyword SelectionStatement SPACE"> </span><span class="Token SelectionStatement BraceDepth-1 LPAREN">(</span><span class="Token MacroDefine Identifier MacroDefine PrimaryExpression ID">WARN_ON_ONCE</span><span class="Token BraceDepth-2 LPAREN">(</span><span class="Token Identifier ID">vmx</span><span class="Token PPtoken POINT">-&gt;</span><span class="Token Identifier ID">nested</span><span class="Token PPtoken DOT">.</span><span class="Token Identifier ID">pml_full</span><span class="Token BraceDepth-2 RPAREN">)</span><span class="Token SelectionStatement BraceDepth-1 RPAREN">)</span><span class="Token SelectionStatement LF">
</span><span class="Token SelectionStatement SPACE">        </span><span class="Token Keyword JumpStatement RETURN">return</span><span class="Token Keyword JumpStatement SPACE"> </span><span class="Token Constant PrimaryExpression NUMBER">1</span><span class="Token JumpStatement SelectionStatement SEMI">;</span><span class="Token JumpStatement SelectionStatement LF">
</span><span class="Token JumpStatement SelectionStatement HighlightLine LF">
</span><span class="Token JumpStatement SelectionStatement SPACE">    </span><span class="Token JumpStatement SelectionStatement COMMENT">/*
     * Check if PML is enabled for the nested guest. Whether eptp bit 6 is
     * set is already checked as part of A/D emulation.
     */</span><span class="Token JumpStatement SelectionStatement LF">
</span><span class="Token JumpStatement SelectionStatement SPACE">    </span><span class="Token Identifier PrimaryExpression ID">vmcs12</span><span class="Token Identifier PrimaryExpression SPACE"> </span><span class="Token AssignOp AssignmentExpression ASSIGN">=</span><span class="Token AssignOp AssignmentExpression SPACE"> </span><span class="Token Identifier PrimaryExpression FunctionCall ID">get_vmcs12</span><span class="Token PostfixExpression UnaryExpression BraceDepth-1 LPAREN">(</span><span class="Token Identifier PrimaryExpression ID">vcpu</span><span class="Token PostfixExpression UnaryExpression BraceDepth-1 RPAREN">)</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">    </span><span class="Token Keyword SelectionStatement IF">if</span><span class="Token Keyword SelectionStatement SPACE"> </span><span class="Token SelectionStatement BraceDepth-1 LPAREN">(</span><span class="Token UnaryOp UnaryExpression BANG">!</span><span class="Token Identifier PrimaryExpression FunctionCall ID">nested_cpu_has_pml</span><span class="Token PostfixExpression UnaryExpression BraceDepth-2 LPAREN">(</span><span class="Token Identifier PrimaryExpression ID">vmcs12</span><span class="Token PostfixExpression UnaryExpression BraceDepth-2 RPAREN">)</span><span class="Token SelectionStatement BraceDepth-1 RPAREN">)</span><span class="Token SelectionStatement LF">
</span><span class="Token SelectionStatement SPACE">        </span><span class="Token Keyword JumpStatement RETURN">return</span><span class="Token Keyword JumpStatement SPACE"> </span><span class="Token Constant PrimaryExpression NUMBER">0</span><span class="Token JumpStatement SelectionStatement SEMI">;</span><span class="Token JumpStatement SelectionStatement LF">
</span><span class="Token JumpStatement SelectionStatement LF">
</span><span class="Token JumpStatement SelectionStatement SPACE">    </span><span class="Token Keyword SelectionStatement IF">if</span><span class="Token Keyword SelectionStatement SPACE"> </span><span class="Token SelectionStatement BraceDepth-1 LPAREN">(</span><span class="Token Identifier PrimaryExpression ID">vmcs12</span><span class="Token PostfixExpression UnaryExpression POINT">-&gt;</span><span class="Token Identifier ID">guest_pml_index</span><span class="Token Identifier SPACE"> </span><span class="Token BinaryOp ConditionalExpression GE">&gt;=</span><span class="Token BinaryOp ConditionalExpression SPACE"> </span><span class="Token Identifier MacroDefine PrimaryExpression ID">PML_ENTITY_NUM</span><span class="Token SelectionStatement BraceDepth-1 RPAREN">)</span><span class="Token SelectionStatement SPACE"> </span><span class="Token CompoundStatement SelectionStatement BraceDepth-1 LCURLY_BRACE">{</span><span class="Token CompoundStatement SelectionStatement LF">
</span><span class="Token CompoundStatement SelectionStatement SPACE">        </span><span class="Token Identifier PrimaryExpression ID">vmx</span><span class="Token PostfixExpression UnaryExpression POINT">-&gt;</span><span class="Token Identifier ID">nested</span><span class="Token PostfixExpression UnaryExpression DOT">.</span><span class="Token Identifier ID">pml_full</span><span class="Token Identifier SPACE"> </span><span class="Token AssignOp AssignmentExpression ASSIGN">=</span><span class="Token AssignOp AssignmentExpression SPACE"> </span><span class="Token Constant PrimaryExpression TRUE">true</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">        </span><span class="Token Keyword JumpStatement RETURN">return</span><span class="Token Keyword JumpStatement SPACE"> </span><span class="Token Constant PrimaryExpression NUMBER">1</span><span class="Token JumpStatement SEMI">;</span><span class="Token JumpStatement LF">
</span><span class="Token JumpStatement SPACE">    </span><span class="Token CompoundStatement SelectionStatement BraceDepth-1 RCURLY_BRACE">}</span><span class="Token CompoundStatement SelectionStatement LF">
</span><span class="Token CompoundStatement SelectionStatement LF">
</span><span class="Token CompoundStatement SelectionStatement SPACE">    </span><span class="Token Identifier PrimaryExpression ID">gpa</span><span class="Token Identifier PrimaryExpression SPACE"> </span><span class="Token AssignOp AssignmentExpression AND_ASSIGN">&amp;=</span><span class="Token AssignOp AssignmentExpression SPACE"> </span><span class="Token UnaryOp UnaryExpression TILDE">~</span><span class="Token Constant PrimaryExpression NUMBER">0xFFFull</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">    </span><span class="Token Identifier PrimaryExpression ID">dst</span><span class="Token Identifier PrimaryExpression SPACE"> </span><span class="Token AssignOp AssignmentExpression ASSIGN">=</span><span class="Token AssignOp AssignmentExpression SPACE"> </span><span class="Token Identifier PrimaryExpression ID">vmcs12</span><span class="Token PostfixExpression UnaryExpression POINT">-&gt;</span><span class="Token Identifier ID">pml_address</span><span class="Token Identifier SPACE"> </span><span class="Token BinaryOp ConditionalExpression PLUS">+</span><span class="Token BinaryOp ConditionalExpression SPACE"> </span><span class="Token Keyword UnaryExpression SIZEOF">sizeof</span><span class="Token UnaryExpression CastExpression BraceDepth-1 LPAREN">(</span><span class="Token Identifier PrimaryExpression ID">u64</span><span class="Token UnaryExpression CastExpression BraceDepth-1 RPAREN">)</span><span class="Token UnaryExpression CastExpression SPACE"> </span><span class="Token BinaryOp MUL">*</span><span class="Token BinaryOp SPACE"> </span><span class="Token Identifier PrimaryExpression ID">vmcs12</span><span class="Token PostfixExpression UnaryExpression POINT">-&gt;</span><span class="Token Identifier ID">guest_pml_index</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">    </span><span class="Token Keyword SelectionStatement IF">if</span><span class="Token Keyword SelectionStatement SPACE"> </span><span class="Token SelectionStatement BraceDepth-1 LPAREN">(</span><span class="Token Identifier PrimaryExpression FunctionCall ID">kvm_write_guest_page</span><span class="Token PostfixExpression UnaryExpression BraceDepth-2 LPAREN">(</span><span class="Token Identifier PrimaryExpression ID">vcpu</span><span class="Token PostfixExpression UnaryExpression POINT">-&gt;</span><span class="Token Identifier ID">kvm</span><span class="Token PostfixExpression UnaryExpression COMMA">,</span><span class="Token PostfixExpression UnaryExpression SPACE"> </span><span class="Token Identifier PrimaryExpression FunctionCall ID">gpa_to_gfn</span><span class="Token PostfixExpression UnaryExpression BraceDepth-0 LPAREN">(</span><span class="Token Identifier PrimaryExpression ID">dst</span><span class="Token PostfixExpression UnaryExpression BraceDepth-0 RPAREN">)</span><span class="Token PostfixExpression UnaryExpression COMMA">,</span><span class="Token PostfixExpression UnaryExpression SPACE"> </span><span class="Token UnaryOp UnaryExpression AMPERSAND">&amp;</span><span class="Token Identifier PrimaryExpression ID">gpa</span><span class="Token PostfixExpression UnaryExpression COMMA">,</span><span class="Token PostfixExpression UnaryExpression LF">
</span><span class="Token PostfixExpression UnaryExpression SPACE">                 </span><span class="Token Identifier PrimaryExpression FunctionCall ID">offset_in_page</span><span class="Token PostfixExpression UnaryExpression BraceDepth-0 LPAREN">(</span><span class="Token Identifier PrimaryExpression ID">dst</span><span class="Token PostfixExpression UnaryExpression BraceDepth-0 RPAREN">)</span><span class="Token PostfixExpression UnaryExpression COMMA">,</span><span class="Token PostfixExpression UnaryExpression SPACE"> </span><span class="Token Keyword UnaryExpression SIZEOF">sizeof</span><span class="Token UnaryExpression CastExpression BraceDepth-0 LPAREN">(</span><span class="Token Identifier PrimaryExpression ID">gpa</span><span class="Token UnaryExpression CastExpression BraceDepth-0 RPAREN">)</span><span class="Token PostfixExpression UnaryExpression BraceDepth-2 RPAREN">)</span><span class="Token SelectionStatement BraceDepth-1 RPAREN">)</span><span class="Token SelectionStatement LF">
</span><span class="Token SelectionStatement SPACE">        </span><span class="Token Keyword JumpStatement RETURN">return</span><span class="Token Keyword JumpStatement SPACE"> </span><span class="Token Constant PrimaryExpression NUMBER">0</span><span class="Token JumpStatement SelectionStatement SEMI">;</span><span class="Token JumpStatement SelectionStatement LF">
</span><span class="Token JumpStatement SelectionStatement LF">
</span><span class="Token JumpStatement SelectionStatement SPACE">    </span><span class="Token Identifier PrimaryExpression ID">vmcs12</span><span class="Token PostfixExpression UnaryExpression POINT">-&gt;</span><span class="Token Identifier ID">guest_pml_index</span><span class="Token PostfixExpression UnaryExpression DEC">--</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">    </span><span class="Token Keyword JumpStatement RETURN">return</span><span class="Token Keyword JumpStatement SPACE"> </span><span class="Token Constant PrimaryExpression NUMBER">0</span><span class="Token JumpStatement SEMI">;</span><span class="Token JumpStatement LF">
</span><span class="Token CompoundStatement Function BraceDepth-0 RCURLY_BRACE">}</span></code></pre><p>当 pml buffer 已满时会触发 VM exit, 此时由操作系统接管获取到 pml_buffer 中的值</p><pre class="language-c"><code><span class="Token Keyword StorageType FunctionReturnType STATIC">static</span><span class="Token Keyword StorageType FunctionReturnType SPACE"> </span><span class="Token Keyword BaseType TypeSpecifier FunctionReturnType INT">int</span><span class="Token Keyword BaseType TypeSpecifier FunctionReturnType SPACE"> </span><span class="Token Identifier DirectDeclaractor FunctionName FunctionName ID">__vmx_handle_exit</span><span class="Token DirectDeclaractor Declarator BraceDepth-0 LPAREN">(</span><span class="Token Keyword StructureType Structure TypeSpecifier STRUCT">struct</span><span class="Token Keyword StructureType Structure TypeSpecifier SPACE"> </span><span class="Token Identifier Structure StructureClass TypeSpecifier ID">kvm_vcpu</span><span class="Token Identifier Structure StructureClass TypeSpecifier SPACE"> </span><span class="Token Pointer Declarator POINTER">*</span><span class="Token Identifier DirectDeclaractor ID">vcpu</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token Keyword Typedefine TypeSpecifier TYPEDEF_ID">fastpath_t</span><span class="Token Keyword Typedefine TypeSpecifier SPACE"> </span><span class="Token Identifier DirectDeclaractor ID">exit_fastpath</span><span class="Token DirectDeclaractor Declarator BraceDepth-0 RPAREN">)</span><span class="Token DirectDeclaractor Declarator LF">
</span><span class="Token CompoundStatement Function BraceDepth-0 LCURLY_BRACE">{</span><span class="Token CompoundStatement Function LF">
</span><span class="Token CompoundStatement Function SPACE">    </span><span class="Token CompoundStatement Function COMMENT">/*
     * Flush logged GPAs PML buffer, this will make dirty_bitmap more
     * updated. Another good is, in kvm_vm_ioctl_get_dirty_log, before
     * querying dirty_bitmap, we only need to kick all vcpus out of guest
     * mode as if vcpus is in root mode, the PML buffer must has been
     * flushed already.  Note, PML is never enabled in hardware while
     * running L2.
     */</span><span class="Token CompoundStatement Function LF">
</span><span class="Token CompoundStatement Function SPACE">    </span><span class="Token Keyword SelectionStatement IF">if</span><span class="Token Keyword SelectionStatement SPACE"> </span><span class="Token SelectionStatement BraceDepth-1 LPAREN">(</span><span class="Token Identifier PrimaryExpression ID">enable_pml</span><span class="Token Identifier PrimaryExpression SPACE"> </span><span class="Token BinaryOp ConditionalExpression AND">&amp;&amp;</span><span class="Token BinaryOp ConditionalExpression SPACE"> </span><span class="Token UnaryOp UnaryExpression BANG">!</span><span class="Token Identifier PrimaryExpression FunctionCall ID">is_guest_mode</span><span class="Token PostfixExpression UnaryExpression BraceDepth-2 LPAREN">(</span><span class="Token Identifier PrimaryExpression ID">vcpu</span><span class="Token PostfixExpression UnaryExpression BraceDepth-2 RPAREN">)</span><span class="Token SelectionStatement BraceDepth-1 RPAREN">)</span><span class="Token SelectionStatement LF">
</span><span class="Token SelectionStatement SPACE">        </span><span class="Token Identifier PrimaryExpression FunctionCall ID">vmx_flush_pml_buffer</span><span class="Token PostfixExpression UnaryExpression BraceDepth-1 LPAREN">(</span><span class="Token Identifier PrimaryExpression ID">vcpu</span><span class="Token PostfixExpression UnaryExpression BraceDepth-1 RPAREN">)</span><span class="Token ExpressionStatement SelectionStatement SEMI">;</span><span class="Token ExpressionStatement SelectionStatement LF">
</span><span class="Token CompoundStatement Function BraceDepth-0 RCURLY_BRACE">}</span></code></pre><p>在 vmx_flush_pml_buffer 中会将 vmx-&gt;pml_pg 的所有 GPA 记录下来后调用 kvm_vcpu_mark_page_dirty 保存到每一个 vcpu 的 slot 中</p><pre class="language-c"><code><span class="Token Keyword StorageType FunctionReturnType STATIC">static</span><span class="Token Keyword StorageType FunctionReturnType SPACE"> </span><span class="Token Keyword BaseType TypeSpecifier FunctionReturnType VOID">void</span><span class="Token Keyword BaseType TypeSpecifier FunctionReturnType SPACE"> </span><span class="Token Identifier DirectDeclaractor FunctionName FunctionName ID">vmx_flush_pml_buffer</span><span class="Token DirectDeclaractor Declarator BraceDepth-0 LPAREN">(</span><span class="Token Keyword StructureType Structure TypeSpecifier STRUCT">struct</span><span class="Token Keyword StructureType Structure TypeSpecifier SPACE"> </span><span class="Token Identifier Structure StructureClass TypeSpecifier ID">kvm_vcpu</span><span class="Token Identifier Structure StructureClass TypeSpecifier SPACE"> </span><span class="Token Pointer Declarator POINTER">*</span><span class="Token Identifier DirectDeclaractor ID">vcpu</span><span class="Token DirectDeclaractor Declarator BraceDepth-0 RPAREN">)</span><span class="Token DirectDeclaractor Declarator LF">
</span><span class="Token CompoundStatement Function BraceDepth-0 LCURLY_BRACE">{</span><span class="Token CompoundStatement Function LF">
</span><span class="Token CompoundStatement Function SPACE">    </span><span class="Token Keyword StructureType Structure TypeSpecifier STRUCT">struct</span><span class="Token Keyword StructureType Structure TypeSpecifier SPACE"> </span><span class="Token Identifier Structure StructureClass TypeSpecifier ID">vcpu_vmx</span><span class="Token Identifier Structure StructureClass TypeSpecifier SPACE"> </span><span class="Token Pointer Declarator POINTER">*</span><span class="Token Identifier DirectDeclaractor ID">vmx</span><span class="Token Identifier DirectDeclaractor SPACE"> </span><span class="Token InitDeclarator ASSIGN">=</span><span class="Token InitDeclarator SPACE"> </span><span class="Token Identifier PrimaryExpression FunctionCall ID">to_vmx</span><span class="Token PostfixExpression UnaryExpression BraceDepth-1 LPAREN">(</span><span class="Token Identifier PrimaryExpression ID">vcpu</span><span class="Token PostfixExpression UnaryExpression BraceDepth-1 RPAREN">)</span><span class="Token Declaration SEMI">;</span><span class="Token Declaration LF">
</span><span class="Token Declaration SPACE">    </span><span class="Token Keyword Typedefine TypeSpecifier TYPEDEF_ID">u64</span><span class="Token Keyword Typedefine TypeSpecifier SPACE"> </span><span class="Token Pointer Declarator POINTER">*</span><span class="Token Identifier DirectDeclaractor ID">pml_buf</span><span class="Token Declaration SEMI">;</span><span class="Token Declaration LF">
</span><span class="Token Declaration SPACE">    </span><span class="Token Keyword Typedefine TypeSpecifier TYPEDEF_ID">u16</span><span class="Token Keyword Typedefine TypeSpecifier SPACE"> </span><span class="Token Identifier DirectDeclaractor ID">pml_idx</span><span class="Token Declaration SEMI">;</span><span class="Token Declaration LF">
</span><span class="Token Declaration LF">
</span><span class="Token Declaration SPACE">    </span><span class="Token Identifier PrimaryExpression ID">pml_idx</span><span class="Token Identifier PrimaryExpression SPACE"> </span><span class="Token AssignOp AssignmentExpression ASSIGN">=</span><span class="Token AssignOp AssignmentExpression SPACE"> </span><span class="Token Identifier PrimaryExpression FunctionCall ID">vmcs_read16</span><span class="Token PostfixExpression UnaryExpression BraceDepth-1 LPAREN">(</span><span class="Token Identifier MacroDefine PrimaryExpression ID">GUEST_PML_INDEX</span><span class="Token PostfixExpression UnaryExpression BraceDepth-1 RPAREN">)</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">    </span><span class="Token ExpressionStatement COMMENT">/* Do nothing if PML buffer is empty */</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">    </span><span class="Token Keyword SelectionStatement IF">if</span><span class="Token Keyword SelectionStatement SPACE"> </span><span class="Token SelectionStatement BraceDepth-1 LPAREN">(</span><span class="Token Identifier PrimaryExpression ID">pml_idx</span><span class="Token Identifier PrimaryExpression SPACE"> </span><span class="Token BinaryOp ConditionalExpression EQ">==</span><span class="Token BinaryOp ConditionalExpression SPACE"> </span><span class="Token PrimaryExpression PostfixExpression BraceDepth-2 LPAREN">(</span><span class="Token Identifier MacroDefine PrimaryExpression ID">PML_ENTITY_NUM</span><span class="Token Identifier MacroDefine PrimaryExpression SPACE"> </span><span class="Token BinaryOp ConditionalExpression MINUS">-</span><span class="Token BinaryOp ConditionalExpression SPACE"> </span><span class="Token Constant PrimaryExpression NUMBER">1</span><span class="Token PrimaryExpression PostfixExpression BraceDepth-2 RPAREN">)</span><span class="Token SelectionStatement BraceDepth-1 RPAREN">)</span><span class="Token SelectionStatement LF">
</span><span class="Token SelectionStatement SPACE">        </span><span class="Token Keyword JumpStatement RETURN">return</span><span class="Token JumpStatement SelectionStatement SEMI">;</span><span class="Token JumpStatement SelectionStatement LF">
</span><span class="Token JumpStatement SelectionStatement LF">
</span><span class="Token JumpStatement SelectionStatement SPACE">    </span><span class="Token JumpStatement SelectionStatement COMMENT">/* PML index always points to next available PML buffer entity */</span><span class="Token JumpStatement SelectionStatement LF">
</span><span class="Token JumpStatement SelectionStatement SPACE">    </span><span class="Token Keyword SelectionStatement IF">if</span><span class="Token Keyword SelectionStatement SPACE"> </span><span class="Token SelectionStatement BraceDepth-1 LPAREN">(</span><span class="Token Identifier PrimaryExpression ID">pml_idx</span><span class="Token Identifier PrimaryExpression SPACE"> </span><span class="Token BinaryOp ConditionalExpression GE">&gt;=</span><span class="Token BinaryOp ConditionalExpression SPACE"> </span><span class="Token MacroDefine Identifier MacroDefine PrimaryExpression ID">PML_ENTITY_NUM</span><span class="Token SelectionStatement BraceDepth-1 RPAREN">)</span><span class="Token SelectionStatement LF">
</span><span class="Token SelectionStatement SPACE">        </span><span class="Token Identifier PrimaryExpression ID">pml_idx</span><span class="Token Identifier PrimaryExpression SPACE"> </span><span class="Token AssignOp AssignmentExpression ASSIGN">=</span><span class="Token AssignOp AssignmentExpression SPACE"> </span><span class="Token Constant PrimaryExpression NUMBER">0</span><span class="Token ExpressionStatement SelectionStatement SEMI">;</span><span class="Token ExpressionStatement SelectionStatement LF">
</span><span class="Token ExpressionStatement SelectionStatement SPACE">    </span><span class="Token Keyword SelectionStatement ELSE">else</span><span class="Token Keyword SelectionStatement LF">
</span><span class="Token Keyword SelectionStatement SPACE">        </span><span class="Token Identifier PrimaryExpression ID">pml_idx</span><span class="Token PostfixExpression UnaryExpression INC">++</span><span class="Token ExpressionStatement SelectionStatement SEMI">;</span><span class="Token ExpressionStatement SelectionStatement LF">
</span><span class="Token ExpressionStatement SelectionStatement LF">
</span><span class="Token ExpressionStatement SelectionStatement SPACE">    </span><span class="Token Identifier PrimaryExpression ID">pml_buf</span><span class="Token Identifier PrimaryExpression SPACE"> </span><span class="Token AssignOp AssignmentExpression ASSIGN">=</span><span class="Token AssignOp AssignmentExpression SPACE"> </span><span class="Token Identifier PrimaryExpression FunctionCall ID">page_address</span><span class="Token PostfixExpression UnaryExpression BraceDepth-1 LPAREN">(</span><span class="Token Identifier PrimaryExpression ID">vmx</span><span class="Token PostfixExpression UnaryExpression POINT">-&gt;</span><span class="Token Identifier ID">pml_pg</span><span class="Token PostfixExpression UnaryExpression BraceDepth-1 RPAREN">)</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">    </span><span class="Token Keyword IterationStatement FOR">for</span><span class="Token Keyword IterationStatement SPACE"> </span><span class="Token IterationStatement BraceDepth-1 LPAREN">(</span><span class="Token IterationStatement SEMI">;</span><span class="Token IterationStatement SPACE"> </span><span class="Token Identifier PrimaryExpression ID">pml_idx</span><span class="Token Identifier PrimaryExpression SPACE"> </span><span class="Token BinaryOp ConditionalExpression LT">&lt;</span><span class="Token BinaryOp ConditionalExpression SPACE"> </span><span class="Token MacroDefine Identifier MacroDefine PrimaryExpression ID">PML_ENTITY_NUM</span><span class="Token IterationStatement SEMI">;</span><span class="Token IterationStatement SPACE"> </span><span class="Token Identifier PrimaryExpression ID">pml_idx</span><span class="Token PostfixExpression UnaryExpression INC">++</span><span class="Token IterationStatement BraceDepth-1 RPAREN">)</span><span class="Token IterationStatement SPACE"> </span><span class="Token CompoundStatement IterationStatement BraceDepth-1 LCURLY_BRACE">{</span><span class="Token CompoundStatement IterationStatement LF">
</span><span class="Token CompoundStatement IterationStatement SPACE">        </span><span class="Token Keyword Typedefine TypeSpecifier TYPEDEF_ID">u64</span><span class="Token Keyword Typedefine TypeSpecifier SPACE"> </span><span class="Token Identifier DirectDeclaractor ID">gpa</span><span class="Token Declaration SEMI">;</span><span class="Token Declaration LF">
</span><span class="Token Declaration LF">
</span><span class="Token Declaration SPACE">        </span><span class="Token Identifier PrimaryExpression ID">gpa</span><span class="Token Identifier PrimaryExpression SPACE"> </span><span class="Token AssignOp AssignmentExpression ASSIGN">=</span><span class="Token AssignOp AssignmentExpression SPACE"> </span><span class="Token Identifier PrimaryExpression ID">pml_buf</span><span class="Token PostfixExpression UnaryExpression BraceDepth-2 LSQUAR_PAREN">[</span><span class="Token Identifier PrimaryExpression ID">pml_idx</span><span class="Token PostfixExpression UnaryExpression BraceDepth-2 RSQUAR_PAREN">]</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">        </span><span class="Token Identifier MacroDefine PrimaryExpression ID">WARN_ON</span><span class="Token BraceDepth-2 LPAREN">(</span><span class="Token Identifier ID">gpa</span><span class="Token Identifier SPACE"> </span><span class="Token PPtoken AMPERSAND">&amp;</span><span class="Token PPtoken SPACE"> </span><span class="Token PPtoken BraceDepth-0 LPAREN">(</span><span class="Token Identifier MacroDefine ID">PAGE_SIZE</span><span class="Token Identifier MacroDefine SPACE"> </span><span class="Token PPtoken MINUS">-</span><span class="Token PPtoken SPACE"> </span><span class="Token PPtoken NUMBER">1</span><span class="Token PPtoken BraceDepth-0 RPAREN">)</span><span class="Token BraceDepth-2 RPAREN">)</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement HighlightLine SPACE">        </span><span class="Token Identifier PrimaryExpression FunctionCall HighlightLine ID">kvm_vcpu_mark_page_dirty</span><span class="Token PostfixExpression UnaryExpression BraceDepth-2 HighlightLine LPAREN">(</span><span class="Token Identifier PrimaryExpression HighlightLine ID">vcpu</span><span class="Token PostfixExpression UnaryExpression HighlightLine COMMA">,</span><span class="Token PostfixExpression UnaryExpression HighlightLine SPACE"> </span><span class="Token Identifier PrimaryExpression HighlightLine ID">gpa</span><span class="Token Identifier PrimaryExpression HighlightLine SPACE"> </span><span class="Token BinaryOp ConditionalExpression HighlightLine SHR">&gt;&gt;</span><span class="Token BinaryOp ConditionalExpression HighlightLine SPACE"> </span><span class="Token Identifier MacroDefine PrimaryExpression HighlightLine ID">PAGE_SHIFT</span><span class="Token PostfixExpression UnaryExpression BraceDepth-2 HighlightLine RPAREN">)</span><span class="Token ExpressionStatement HighlightLine SEMI">;</span><span class="Token ExpressionStatement HighlightLine LF">
</span><span class="Token ExpressionStatement SPACE">    </span><span class="Token CompoundStatement IterationStatement BraceDepth-1 RCURLY_BRACE">}</span><span class="Token CompoundStatement IterationStatement LF">
</span><span class="Token CompoundStatement IterationStatement LF">
</span><span class="Token CompoundStatement IterationStatement SPACE">    </span><span class="Token CompoundStatement IterationStatement COMMENT">/* reset PML index */</span><span class="Token CompoundStatement IterationStatement LF">
</span><span class="Token CompoundStatement IterationStatement SPACE">    </span><span class="Token Identifier PrimaryExpression FunctionCall ID">vmcs_write16</span><span class="Token PostfixExpression UnaryExpression BraceDepth-1 LPAREN">(</span><span class="Token MacroDefine Identifier MacroDefine PrimaryExpression ID">GUEST_PML_INDEX</span><span class="Token PostfixExpression UnaryExpression COMMA">,</span><span class="Token PostfixExpression UnaryExpression SPACE"> </span><span class="Token MacroDefine Identifier MacroDefine PrimaryExpression ID">PML_ENTITY_NUM</span><span class="Token Identifier MacroDefine PrimaryExpression SPACE"> </span><span class="Token BinaryOp ConditionalExpression MINUS">-</span><span class="Token BinaryOp ConditionalExpression SPACE"> </span><span class="Token Constant PrimaryExpression NUMBER">1</span><span class="Token PostfixExpression UnaryExpression BraceDepth-1 RPAREN">)</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Token CompoundStatement Function BraceDepth-0 RCURLY_BRACE">}</span><span class="Token CompoundStatement Function LF">
</span><span class="Token CompoundStatement Function LF">
</span><span class="Token Keyword BaseType TypeSpecifier FunctionReturnType VOID">void</span><span class="Token Keyword BaseType TypeSpecifier FunctionReturnType SPACE"> </span><span class="Token Identifier DirectDeclaractor FunctionName FunctionName ID">kvm_vcpu_mark_page_dirty</span><span class="Token DirectDeclaractor Declarator BraceDepth-0 LPAREN">(</span><span class="Token Keyword StructureType Structure TypeSpecifier STRUCT">struct</span><span class="Token Keyword StructureType Structure TypeSpecifier SPACE"> </span><span class="Token Identifier Structure StructureClass TypeSpecifier ID">kvm_vcpu</span><span class="Token Identifier Structure StructureClass TypeSpecifier SPACE"> </span><span class="Token Pointer Declarator POINTER">*</span><span class="Token Identifier DirectDeclaractor ID">vcpu</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token Keyword Typedefine TypeSpecifier TYPEDEF_ID">gfn_t</span><span class="Token Keyword Typedefine TypeSpecifier SPACE"> </span><span class="Token Identifier DirectDeclaractor ID">gfn</span><span class="Token DirectDeclaractor Declarator BraceDepth-0 RPAREN">)</span><span class="Token DirectDeclaractor Declarator LF">
</span><span class="Token CompoundStatement Function BraceDepth-0 LCURLY_BRACE">{</span><span class="Token CompoundStatement Function LF">
</span><span class="Token CompoundStatement Function SPACE">    </span><span class="Token Keyword StructureType Structure TypeSpecifier STRUCT">struct</span><span class="Token Keyword StructureType Structure TypeSpecifier SPACE"> </span><span class="Token Identifier Structure StructureClass TypeSpecifier ID">kvm_memory_slot</span><span class="Token Identifier Structure StructureClass TypeSpecifier SPACE"> </span><span class="Token Pointer Declarator POINTER">*</span><span class="Token Identifier DirectDeclaractor ID">memslot</span><span class="Token Declaration SEMI">;</span><span class="Token Declaration LF">
</span><span class="Token Declaration LF">
</span><span class="Token Declaration SPACE">    </span><span class="Token Identifier PrimaryExpression ID">memslot</span><span class="Token Identifier PrimaryExpression SPACE"> </span><span class="Token AssignOp AssignmentExpression ASSIGN">=</span><span class="Token AssignOp AssignmentExpression SPACE"> </span><span class="Token Identifier PrimaryExpression FunctionCall ID">kvm_vcpu_gfn_to_memslot</span><span class="Token PostfixExpression UnaryExpression BraceDepth-1 LPAREN">(</span><span class="Token Identifier PrimaryExpression ID">vcpu</span><span class="Token PostfixExpression UnaryExpression COMMA">,</span><span class="Token PostfixExpression UnaryExpression SPACE"> </span><span class="Token Identifier PrimaryExpression ID">gfn</span><span class="Token PostfixExpression UnaryExpression BraceDepth-1 RPAREN">)</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">    </span><span class="Token Identifier PrimaryExpression FunctionCall ID">mark_page_dirty_in_slot</span><span class="Token PostfixExpression UnaryExpression BraceDepth-1 LPAREN">(</span><span class="Token Identifier PrimaryExpression ID">vcpu</span><span class="Token PostfixExpression UnaryExpression POINT">-&gt;</span><span class="Token Identifier ID">kvm</span><span class="Token PostfixExpression UnaryExpression COMMA">,</span><span class="Token PostfixExpression UnaryExpression SPACE"> </span><span class="Token Identifier PrimaryExpression ID">memslot</span><span class="Token PostfixExpression UnaryExpression COMMA">,</span><span class="Token PostfixExpression UnaryExpression SPACE"> </span><span class="Token Identifier PrimaryExpression ID">gfn</span><span class="Token PostfixExpression UnaryExpression BraceDepth-1 RPAREN">)</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Token CompoundStatement Function BraceDepth-0 RCURLY_BRACE">}</span></code></pre><p>因此其实 Linux/KVM 已经完成了对 PML buffer 中数据的封装, 我们只需要通过 KVM 的 api 接口即可获取到 dirty page 的值, 在 <a href="../../kvm/api" target="_self">api</a> 中我们介绍了 <code>KVM_GET_DIRTY_LOG</code>, 其可以返回一个 kvm_dirty_log 结构体记录当前进程的所有页面的 dirty_bitmap 情况</p><pre class="language-c"><code><span class="Token Keyword StructureType Structure TypeSpecifier STRUCT">struct</span><span class="Token Keyword StructureType Structure TypeSpecifier SPACE"> </span><span class="Token Identifier Structure StructureClass TypeSpecifier ID">kvm_dirty_log</span><span class="Token Identifier Structure StructureClass TypeSpecifier SPACE"> </span><span class="Token Structure BraceDepth-0 LCURLY_BRACE">{</span><span class="Token Structure LF">
</span><span class="Token Structure SPACE">    </span><span class="Token MacroDefine Identifier MacroDefine MacroInvocation TypeSpecifier ID">__u32</span><span class="Token Identifier MacroDefine MacroInvocation TypeSpecifier SPACE"> </span><span class="Token Identifier DirectDeclaractor TypeSpecifier ID">slot</span><span class="Token StructDeclaration SEMI">;</span><span class="Token StructDeclaration LF">
</span><span class="Token StructDeclaration SPACE">    </span><span class="Token MacroDefine MacroDefine Identifier MacroDefine MacroInvocation TypeSpecifier ID">__u32</span><span class="Token Identifier MacroDefine MacroInvocation TypeSpecifier SPACE"> </span><span class="Token Identifier DirectDeclaractor TypeSpecifier ID">padding</span><span class="Token StructDeclaration SEMI">;</span><span class="Token StructDeclaration LF">
</span><span class="Token StructDeclaration SPACE">    </span><span class="Token Keyword StructureType Structure TypeSpecifier TypeSpecifier UNION">union</span><span class="Token Keyword StructureType Structure TypeSpecifier TypeSpecifier SPACE"> </span><span class="Token Structure BraceDepth-1 LCURLY_BRACE">{</span><span class="Token Structure LF">
</span><span class="Token Structure SPACE">        </span><span class="Token Keyword BaseType TypeSpecifier TypeSpecifier TypeSpecifier VOID">void</span><span class="Token Keyword BaseType TypeSpecifier TypeSpecifier TypeSpecifier SPACE"> </span><span class="Token MacroDefine Identifier MacroDefine MacroInvocation TypeSpecifier TypeSpecifier ID">__user</span><span class="Token Identifier MacroDefine MacroInvocation TypeSpecifier TypeSpecifier SPACE"> </span><span class="Token Pointer Declarator POINTER">*</span><span class="Token Identifier DirectDeclaractor TypeSpecifier TypeSpecifier ID">dirty_bitmap</span><span class="Token StructDeclaration SEMI">;</span><span class="Token StructDeclaration SPACE"> </span><span class="Token StructDeclaration COMMENT">/* one bit per page */</span><span class="Token StructDeclaration LF">
</span><span class="Token StructDeclaration SPACE">        </span><span class="Token MacroDefine Identifier MacroDefine MacroInvocation TypeSpecifier TypeSpecifier ID">__u64</span><span class="Token Identifier MacroDefine MacroInvocation TypeSpecifier TypeSpecifier SPACE"> </span><span class="Token Identifier DirectDeclaractor TypeSpecifier TypeSpecifier ID">padding</span><span class="Token StructDeclaration SEMI">;</span><span class="Token StructDeclaration LF">
</span><span class="Token StructDeclaration SPACE">    </span><span class="Token Structure BraceDepth-1 RCURLY_BRACE">}</span><span class="Token StructDeclaration SEMI">;</span><span class="Token StructDeclaration LF">
</span><span class="Token Structure BraceDepth-0 RCURLY_BRACE">}</span><span class="Token Declaration SEMI">;</span></code></pre><p><a href="https://github.com/luzhixing12345/klinux/tree/main/tools/testing/selftests/kvm" target="_blank">tools/testing/selftests/kvm</a> 中提供了相关的代码工具, 参考其中的 <a href="https://github.com/luzhixing12345/klinux/blob/main/tools/testing/selftests/kvm/dirty_log_test.c" target="_blank">dirty_log_test.c</a>, 使用的基本逻辑如下</p><ol start="1"><li>调用 kvm 的 ioctl 接口, 获取到 kvm_dirty_log</li></ol><ol start="2"><li>遍历所有页面, 判断对于页面是否为脏页</li></ol><ol start="3"><li>得到计数结果</li></ol><pre class="language-c"><code><span class="Token Keyword BaseType TypeSpecifier FunctionReturnType VOID">void</span><span class="Token Keyword BaseType TypeSpecifier FunctionReturnType SPACE"> </span><span class="Token Identifier DirectDeclaractor FunctionName FunctionName ID">use_pml</span><span class="Token DirectDeclaractor Declarator BraceDepth-0 LPAREN">(</span><span class="Token DirectDeclaractor Declarator BraceDepth-0 RPAREN">)</span><span class="Token DirectDeclaractor Declarator SPACE"> </span><span class="Token CompoundStatement Function BraceDepth-0 LCURLY_BRACE">{</span><span class="Token CompoundStatement Function LF">
</span><span class="Token CompoundStatement Function SPACE">    </span><span class="Token CompoundStatement Function COMMENT">// 调用 ioctl 拿到 log 信息</span><span class="Token CompoundStatement Function LF">
</span><span class="Token CompoundStatement Function SPACE">    </span><span class="Token Keyword StructureType Structure TypeSpecifier STRUCT">struct</span><span class="Token Keyword StructureType Structure TypeSpecifier SPACE"> </span><span class="Token Identifier Structure StructureClass TypeSpecifier ID">kvm_dirty_log</span><span class="Token Identifier Structure StructureClass TypeSpecifier SPACE"> </span><span class="Token Identifier DirectDeclaractor ID">log</span><span class="Token Declaration SEMI">;</span><span class="Token Declaration LF">
</span><span class="Token Declaration SPACE">    </span><span class="Token Identifier PrimaryExpression FunctionCall ID">vm_ioctl</span><span class="Token PostfixExpression UnaryExpression BraceDepth-1 LPAREN">(</span><span class="Token Identifier PrimaryExpression ID">vm</span><span class="Token PostfixExpression UnaryExpression COMMA">,</span><span class="Token PostfixExpression UnaryExpression SPACE"> </span><span class="Token Identifier MacroDefine PrimaryExpression ID">KVM_GET_DIRTY_LOG</span><span class="Token PostfixExpression UnaryExpression COMMA">,</span><span class="Token PostfixExpression UnaryExpression SPACE"> </span><span class="Token UnaryOp UnaryExpression AMPERSAND">&amp;</span><span class="Token Identifier PrimaryExpression ID">log</span><span class="Token PostfixExpression UnaryExpression BraceDepth-1 RPAREN">)</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">    </span><span class="Token ExpressionStatement COMMENT">// 拿到 host 的页面数量</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">    </span><span class="Token Identifier PrimaryExpression ID">host_num_pages</span><span class="Token Identifier PrimaryExpression SPACE"> </span><span class="Token AssignOp AssignmentExpression ASSIGN">=</span><span class="Token AssignOp AssignmentExpression SPACE"> </span><span class="Token Identifier PrimaryExpression FunctionCall ID">vm_num_host_pages</span><span class="Token PostfixExpression UnaryExpression BraceDepth-1 LPAREN">(</span><span class="Token Identifier PrimaryExpression ID">mode</span><span class="Token PostfixExpression UnaryExpression COMMA">,</span><span class="Token PostfixExpression UnaryExpression SPACE"> </span><span class="Token Identifier PrimaryExpression ID">guest_num_pages</span><span class="Token PostfixExpression UnaryExpression BraceDepth-1 RPAREN">)</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">    </span><span class="Token ExpressionStatement COMMENT">// 在 dirty_bitmap 中遍历所有页面, 如果 bit 为 1 则是 dirty, 否则是 clean</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">    </span><span class="Token Keyword IterationStatement FOR">for</span><span class="Token Keyword IterationStatement SPACE"> </span><span class="Token IterationStatement BraceDepth-1 LPAREN">(</span><span class="Token Identifier PrimaryExpression ID">page</span><span class="Token Identifier PrimaryExpression SPACE"> </span><span class="Token AssignOp AssignmentExpression ASSIGN">=</span><span class="Token AssignOp AssignmentExpression SPACE"> </span><span class="Token Constant PrimaryExpression NUMBER">0</span><span class="Token IterationStatement SEMI">;</span><span class="Token IterationStatement SPACE"> </span><span class="Token Identifier PrimaryExpression ID">page</span><span class="Token Identifier PrimaryExpression SPACE"> </span><span class="Token BinaryOp ConditionalExpression LT">&lt;</span><span class="Token BinaryOp ConditionalExpression SPACE"> </span><span class="Token Identifier PrimaryExpression ID">host_num_pages</span><span class="Token IterationStatement SEMI">;</span><span class="Token IterationStatement SPACE"> </span><span class="Token Identifier PrimaryExpression ID">page</span><span class="Token Identifier PrimaryExpression SPACE"> </span><span class="Token AssignOp AssignmentExpression ADD_ASSIGN">+=</span><span class="Token AssignOp AssignmentExpression SPACE"> </span><span class="Token Identifier PrimaryExpression ID">step</span><span class="Token IterationStatement BraceDepth-1 RPAREN">)</span><span class="Token IterationStatement SPACE"> </span><span class="Token CompoundStatement IterationStatement BraceDepth-1 LCURLY_BRACE">{</span><span class="Token CompoundStatement IterationStatement LF">
</span><span class="Token CompoundStatement IterationStatement SPACE">        </span><span class="Token Keyword SelectionStatement IF">if</span><span class="Token Keyword SelectionStatement SPACE"> </span><span class="Token SelectionStatement BraceDepth-2 LPAREN">(</span><span class="Token Identifier PrimaryExpression FunctionCall ID">__test_and_clear_bit_le</span><span class="Token PostfixExpression UnaryExpression BraceDepth-0 LPAREN">(</span><span class="Token Identifier PrimaryExpression ID">page</span><span class="Token PostfixExpression UnaryExpression COMMA">,</span><span class="Token PostfixExpression UnaryExpression SPACE"> </span><span class="Token Identifier PrimaryExpression ID">log</span><span class="Token PostfixExpression UnaryExpression DOT">.</span><span class="Token Identifier ID">dirty_bitmap</span><span class="Token PostfixExpression UnaryExpression BraceDepth-0 RPAREN">)</span><span class="Token SelectionStatement BraceDepth-2 RPAREN">)</span><span class="Token SelectionStatement SPACE"> </span><span class="Token CompoundStatement SelectionStatement BraceDepth-2 LCURLY_BRACE">{</span><span class="Token CompoundStatement SelectionStatement LF">
</span><span class="Token CompoundStatement SelectionStatement SPACE">            </span><span class="Token Identifier PrimaryExpression ID">host_dirty_count</span><span class="Token PostfixExpression UnaryExpression INC">++</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">        </span><span class="Token CompoundStatement SelectionStatement BraceDepth-2 RCURLY_BRACE">}</span><span class="Token CompoundStatement SelectionStatement SPACE"> </span><span class="Token Keyword SelectionStatement ELSE">else</span><span class="Token Keyword SelectionStatement SPACE"> </span><span class="Token CompoundStatement SelectionStatement BraceDepth-2 LCURLY_BRACE">{</span><span class="Token CompoundStatement SelectionStatement LF">
</span><span class="Token CompoundStatement SelectionStatement SPACE">            </span><span class="Token Identifier PrimaryExpression ID">host_clear_count</span><span class="Token PostfixExpression UnaryExpression INC">++</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">        </span><span class="Token CompoundStatement SelectionStatement BraceDepth-2 RCURLY_BRACE">}</span><span class="Token CompoundStatement SelectionStatement LF">
</span><span class="Token CompoundStatement SelectionStatement SPACE">    </span><span class="Token CompoundStatement IterationStatement BraceDepth-1 RCURLY_BRACE">}</span><span class="Token CompoundStatement IterationStatement LF">
</span><span class="Token CompoundStatement Function BraceDepth-0 RCURLY_BRACE">}</span></code></pre><h2 id="h2-2">性能分析</h2><p>论文 Extending Intel PML for Hardware-Assisted Working Set Size Estimation of VMs 对比分析了启用/禁用 PML 的性能表现, 其中性能指标在于两个方面</p><ol start="1"><li>是否影响了程序性能(执行时间), PML 是否影响应用程序的读/写内存速度</li></ol><ol start="2"><li>是否影响了迁移速度, PML 是否影响内存迁移的速度</li></ol><h3 id="h3-3">读写</h3><p>benchmark 是一段简短的代码, 以不同的比例进行读写操作, 判断吞吐量</p><p><a data-lightbox="example-1" href="https://raw.githubusercontent.com/learner-lu/picbed/master/20241030213530.png"><img loading="lazy" src="https://raw.githubusercontent.com/learner-lu/picbed/master/20241030213530.png" alt="20241030213530"></a></p><p>实验结果如下, 纵轴为读写速度, 对比了 PML 和 noPML 在不同读写比例下的读写速度变化</p><p><a data-lightbox="example-1" href="https://raw.githubusercontent.com/learner-lu/picbed/master/20241030213432.png"><img loading="lazy" src="https://raw.githubusercontent.com/learner-lu/picbed/master/20241030213432.png" alt="20241030213432"></a></p><p>实验观察到<b>开启 PML 会对应用程序的性能产生负面影响</b>,如所有曲线中的两个下降峰值所示.然而,PML 将这种影响略微最小化了 0.06% 到 0.95%.减少的幅度取决于工作负载的写入强度.(写入强度越大, 性能下降越多, 但是在可以接受的范围之内)</p><p>尽管将 PML 用于读密集型工作负载会略微降低应用程序的性能,但其优势对于写密集型工作负载更为重要</p><blockquote style="border-left-color: #f08833; background-color: #ffefe3;"><p><div style="color: #f08833;"><img class="icon-question" loading="lazy" src="../../../img/question.svg" alt="[!QUESTION]"> QUESTION </div> 这张图我感觉是不是 PML 和 noPML 标反了? 感觉从图中看紫色的要更低一些</p></blockquote><h3 id="h3-4">迁移速度</h3><p>下图为迁移时间的结果, 纵轴表示 PML/noPML 的加速比, 越高说明迁移速度越快, 横轴为不同读写比例的情况</p><p><a data-lightbox="example-1" href="https://raw.githubusercontent.com/learner-lu/picbed/master/20241030220532.png"><img loading="lazy" src="https://raw.githubusercontent.com/learner-lu/picbed/master/20241030220532.png" alt="20241030220532"></a></p><p>我们观察到,PML 将实时迁移期间方法 save() 的执行时间减少了 0.98% 到 10.18%. 特别是读取密集型应用程序的迁移速度要快得多.</p><p>这是由于两个主要原因.</p><ul><li>当使用 PML 时,如果页面尚未记录(页面的 GPA 不存在于 pml 日志记录缓冲区中),这意味着它尚未被修改,然后<b>可以立即迁移</b>.<b>VMM不再需要首先使其无效</b>.</li></ul><ul><li>随着工作负载执行的写入操作减少,记录的 GPA 也会减少,因此虚拟机管理程序的日志记录缓冲区遍历操作也会减少,迁移速度也会更快.请注意,加速实时迁移非常重要,因为它允许您快速释放计算机进行维护、隔离损坏的虚拟机等</li></ul><h2 id="h2-5">问题</h2><p>内存页面跟踪是跟踪虚拟机内存访问的关键机制,以便管理程序(或虚拟机监视器)可以改进其实现的各种服务的内存管理.内存页面跟踪是几个基本任务的核心,例如</p><ul><li>用于故障后恢复的检查点</li></ul><ul><li>用于维护和动态打包的实时迁移</li></ul><ul><li>估计内存过量使用的工作集大小(WSS)</li></ul><ul><li>快速恢复.</li></ul><p>PML可用于WSS估计,但需要改进以提供准确的估计,概括来说是因为不跟踪读取访问并且无法识别热点页.事实上,当前 PML 的设计主要关注写入工作负载.<b>即使页面被访问多次,它也只记录页面的 GPA 一次</b>.因此,冷页很可能被计入工作集中,高估了后者,从而导致内存浪费.此外,PML 会给估计 WSS 的虚拟机带来不可接受的开销.事实上,当 PML 日志记录缓冲区已满时(在记录 512 个 GPA 之后),计算 WSS 的 VM 的 CPU 会触发 VMExit.该 VMExit 的处理程序会消耗从 VM 的 CPU 配额中获取的 CPU 时间</p><p>但是仅使用 PML 的系统<b>无法提供准确的 WSS 估计</b>. 原因有三点:</p><ol start="1"><li>PML 仅跟踪写入 WSS(因此称为页面修改日志记录). 对于读取页面的访问并不会追踪</li></ol><ol start="2"><li>PML 不跟踪热页(甚至写入热页).根据当前的 PML 设计, 即使一个页面在短时间内被多次引用, 访问的页面也仅记录一次.使用这种设计进行WSS估计,无法区分热页和冷页,这导致高估了虚拟机的实际内存需求.</li></ol><ol start="3"><li>PML 降低了估计 WSS 的 VM 的性能.事实上,PML 日志记录缓冲区已满事件的处理不应该由估计 WSS 的 VM 的 CPU 来完成.事实上,剥夺了用户虚拟机的 CPU 配额是不公平的,因为WSS估计只对数据中心运营商有利.<p>作者测试了当前 PML 设计的开销,以估计来自 BigDataBench (读取、写入和排序应用程序)和 HPL Linpack 应用程序的 WSS.对于 BigDataBench 应用程序,输入数据集为 10GB.我们运行带有和不带有 PML 的每个应用程序并计算开销,如下图所示.</p><blockquote><p>纵坐标表示 PML/noPML 的负载比, 越高说明对性能影响越大</p></blockquote><p><a data-lightbox="example-1" href="https://raw.githubusercontent.com/learner-lu/picbed/master/20241031110155.png"><img loading="lazy" src="https://raw.githubusercontent.com/learner-lu/picbed/master/20241031110155.png" alt="20241031110155"></a></p><p>可以发现读取密集型应用程序(read)不会受到使用 PML 的影响,因为它只跟踪页面修改.然而,其他工作负载(例如 HPL Linpack)受到 PML 的使用的显着影响,性能下降高达 34.9%</p></li></ol><h2 id="h2-6">结论</h2><ul><li>PML减少了VM实时迁移时间.</li></ul><ul><li>PML略微降低了实时迁移期间的应用程序性能开销.</li></ul><ul><li>无法使用PML及其当前设计来进行有效的WSS估计,因为基于它的WSS估计系统将无法准确地估计VM的整个工作集.</li></ul><h2 id="h2-7">改进: PRL</h2><p>前文提到了 PML 无法有效的估计 WSS, 因为仅追踪写, 不追踪热页, 降低 VM 性能. 因此论文的作者提出了一种改进的方案 PRL, 其原理如下</p><p><a data-lightbox="example-1" href="https://raw.githubusercontent.com/learner-lu/picbed/master/20241031150753.png"><img loading="lazy" src="https://raw.githubusercontent.com/learner-lu/picbed/master/20241031150753.png" alt="20241031150753"></a></p><ol start="1"><li>VM 的 CPU 开始记录 GPA</li></ol><ol start="2"><li>当 PRL 日志缓冲区已满时,VM 的 CPU 会向专用 dom0 的 CPU 发送 IPI(该 CPU 专门负责计算VM的工作集)</li></ol><ol start="3"><li>VMM 将 PRL 日志缓冲区的内容复制到与 dom0 共享的更大缓冲区(同时虚拟机继续执行而不会中断),并且 PRL 索引重置为 511.</li></ol><ol start="4"><li>PML 日志记录进程重新启动</li></ol><ol start="5"><li>同时, WSS 估计系统对日志完整处理程序生成的结果进行操作</li></ol><p>其中最核心的改进位于<b>新增了一个 dom0 的 vCPU</b>, 用于处理 log 日志. 之前的性能影响主要是因为 buffer 满时需要产生 VMEXIT 导致 vCPU 正常运行任务, 这种模式相当于异步处理 log 日志</p><p>可能存在的一点问题是<b>如果在 dom0 vCPU 异步 copy 日志期间[3]来了新的日志[1]怎么办?</b> 作者针对这个问题也给出了解释: 此时 GPA 不会被记录,PRL 过程也会结束.有些人可能会认为 PRL 过程在处理事件处理程序时会丢失一些 GPA,我们声称它不会影响 WSS 估计.确实,如果漏掉的GPA属于工作集,很可能在不久的将来(重新激活PRL机制后)就会出现,因为它很热.否则,GPA 是冷的,其损失不会改变 WSS 估计.第 4 节中描述的评估结果支持我们的主张</p><h2 id="h2-8">参考</h2><ul><li>Extending Intel PML for Hardware-Assisted Working  Set Size Estimation of VMs</li></ul><ul><li>Out of hypervisor (ooh): Efficient dirty page tracking in userspace using hardware virtualization features</li></ul><ul><li>Ldt: Lightweight dirty tracking of memory pages for x86 systems</li></ul><ul><li><a href="https://os.itec.kit.edu/downloads/ba_2016_sch%c3%b6tterl-glausch_PML_for_Lightweight_Continuous_Checkpointing.pdf" target="_blank">itec os</a></li></ul><ul><li><a href="https://lkml.org/lkml/2018/11/28/738" target="_blank">LKML: Paolo Bonzini: [PATCH 3/3] kvm: introduce manual dirty log reprotect</a></li></ul><ul><li><a href="https://www.spinics.net/lists/kvm/msg112904.html" target="_blank">spinics msg112904</a></li></ul><ul><li><a href="https://github.com/firecracker-microvm/firecracker/issues/1132" target="_blank">Use KVM_CAP_MANUAL_DIRTY_LOG_PROTECT when getting dirty log</a></li></ul><ul><li><a href="https://docs.kernel.org/virt/kvm/api.html#kvm-cap-manual-dirty-log-protect2" target="_blank">kernel docs</a></li></ul><ul><li><a href="https://blog.csdn.net/huang987246510/article/details/114379675" target="_blank">QEMU内存迁移压测工具简介</a></li></ul></div>
    <div class="dir-tree"><ul><li><a href="../../md-docs/README" >README</a></li></ul><ul><li><a href="../../md-docs/虚拟化技术" >虚拟化技术</a></li></ul><ul><li><a href="../../md-docs/内存虚拟化" >内存虚拟化</a></li></ul><ul><li><a href="../../md-docs/CPU虚拟化" >CPU虚拟化</a></li></ul><ul><li><a href="../../md-docs/IO虚拟化" >IO虚拟化</a></li></ul><ul><li><a href="../../md-docs/网络虚拟化" >网络虚拟化</a></li></ul><ul><li><a href="../../qemu/intro" >qemu</a><ul><li><a href="../../qemu/intro" >intro</a></li></ul><ul><li><a href="../../qemu/glib" >glib</a></li></ul><ul><li><a href="../../qemu/qom" >qom</a></li></ul><ul><li><a href="../../qemu/system" >system</a></li></ul><ul><li><a href="../../qemu/tcg" >tcg</a></li></ul><ul><li><a href="../../qemu/vhost-user" >vhost-user</a></li></ul><ul><li><a href="../../qemu/EPT" >EPT</a></li></ul><ul><li><a href="../../qemu/machine" >machine</a></li></ul><ul><li><a href="../../qemu/args" >args</a></li></ul><ul><li><a href="../../qemu/contribute" >contribute</a></li></ul></li></ul><ul><li><a href="../../kvm/intro" >kvm</a><ul><li><a href="../../kvm/intro" >intro</a></li></ul><ul><li><a href="../../kvm/init" >init</a></li></ul><ul><li><a href="../../kvm/pml" >pml</a></li></ul><ul><li><a href="../../kvm/libvirt" >libvirt</a></li></ul><ul><li><a href="../../kvm/api" >api</a></li></ul><ul><li><a href="../../kvm/ept-trace" >ept-trace</a></li></ul><ul><li><a href="../../kvm/qemu" >qemu</a></li></ul><ul><li><a href="../../kvm/slot" >slot</a></li></ul></li></ul><ul><li><a href="../../cxl/intro" >cxl</a><ul><li><a href="../../cxl/intro" >intro</a></li></ul></li></ul></div>
    <div class="zood"><a class="" href="https://github.com/luzhixing12345/zood" target="_blank">zood</a></div>
    <script type="text/javascript" src="../../../js/next_front.js"></script><script>addLink("../../kvm/init","../../kvm/libvirt","ab");</script><script type="text/javascript" src="../../../js/change_mode.js"></script><script>addChangeModeButton("../../../img/sun.png","../../../img/moon.png");</script><script type="text/javascript" src="../../../js/copy_code.js"></script><script>addCodeCopy("../../../img/before_copy.png","../../../img/after_copy.png");</script><script type="text/javascript" src="../../../js/navigator.js"></script><script type="text/javascript" src="../../../js/picture_preview.js"></script><script type="text/javascript" src="../../../js/global_js_configuration.js"></script>
</body>

</html>